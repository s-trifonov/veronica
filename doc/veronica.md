# Вероника, стенд для разметки изображений

Программа Вероника предназначена для разметки серийных изображений, выполненных на электронном микроскопе, в общем виде - в целях анализа этих отображений. В своей первой версии аналитический функционал программы минимален  (в перспективе этот аспект будет развиваться), и основной задачей программы в настоящий момент является проведение ручной разметки изображений и аккуратноe  и надёжное сохранениe результатов. 

Программа реализует среду разметки серийных изображений, и ориентирована на то, чтобы сделать этот процесс удобным и надёжным. Критерии удобства здесь преследуют не только и не столько эстетические цели: от их уровня зависит качество разметки, возможность доверять её результату. Программа находится в фазе разработки и стабилизации, вполне возможны её падения. Случаи таких падений, а также пожелания по улучшениям работы просьба по возможности незамедлительно сообщать по адресу разработчика: Trf@ya.ru
Желательно регулярное обновление версий программы из репозитория - по крайней мере в периоды, когда разработка программы ведётся активно. 

**Контекст проекта**: существенная часть регламентаций при работе в среде программы определяется конкретными требованиями задачи разметки и её организации. В настоящее время подразумевается наличие только <ins>одного проекта: разметка везикул</ins>, но в перспективе проектов может быть много. Ниже маркировка "контекст проекта" означает, что конкретные требования должны определяться на этом уровне, а не на уровне общей среды. 

## Установка и администрирование 

### MongoDb, как сервис хранения результатов разметки 

Программа/среда использует в качестве сервиса хранения результата сервис MongoDB. Это - универсальная база данных, хранящая данные в формате JSON, популярное средство в среде проектов с отрытым кодом. (Известно, что это средство "очень тормозит" на "больших" объёмах данных - но наши потребности не предполагают столь больших объёмов даже в перспективе.)

Он без труда устанавливается на Linux, с минимальными сложностями на Windows:
https://www.mongodb.com/docs/manual/installation/

Для клиентов сервиса он идентифицируется адресом машины и портом.

В контексте проекта по-видимому желательно, чтобы все результаты по разметке собирались вместе и использовались в общем комплексе - в этом случае рекомендуется развернуть единый общий сервис MongoDB с доступом через Интранет. Возможен другой вариант эксплуатации: установка сервиса MongoDB локально, на каждом из компьютеров, и использование этого сервиса каждым разметкиком в автономе. В любо случае: *перед разворачиванием и использованием программы* рекомендовано установить какой-либо вариант сервиса MongoDb.

### Установка программы

#### 0. Предустановленные программы
Требуется: 
* python3, версии 3.10 и и выше
* программа git.

#### 1. Загрузка из репозитория

Основной репозиторий кода программы:
https://github.com/s-trifonov/veronica

От пользователя требуется выбрать директорию, куда произойдёт загрузка. Например, это директория 
"/home/user/" (на Windows можно начать с корня диска, например "C:")

> cd /home/user
> git clone https://github.com/s-trifonov/veronica.git

При успехе создаётся директория "veronica" в текущей директории. В примере это "/home/user/veronica" ("C:/veronica").

Для обновления версии:
> cd /home/user/veronica
> git pull

#### 2. Виртуальное окружение

Для работы с программой _в Linux_ рекомендуется создать и использовать виртуальное окружение. 

(_В варианте Windows_ - не знаю, как правильно использовать виртуальное окружение. 
Вариант: полная инсталляция Python3 производится специально для использования данной программы Вероника. В этом случае установка пакетов (pip install -r ...), см. ниже, выполняется без виртуального окружения, прямо вовнутрь инсталляции Питона.) 

В качестве примера ниже показывается, как создаётся и используется виртуальное окружение с именем ".veronica-venv" внутри корневой директории пользователя "~" (создавать окружение можно с другим именем и в другой директории):

* Создание окружения:
> python3 -m venv ~/.veronica-venv

* Активация окружения: (_внимание, команду активации надо выполнять не только при инсталляции, но и перед запуском самой программы!, при запуске shell_)
> source ~/.veronica-venv/bin/activate

* Инсталляция пакетов, требуемых для запуска основной программы (выполняется один раз, при установке; подразумевается, что активация виртуальным окружением уже выполнена; директория "/home/user/veronica/" указана в соответствии с примером)

> pip install -r /home/user/veronica/requirements.txt 

#### 3. Директории и файлы, связанные с запуском

Для запуска программы необходимо определить расположение следующих файлов и директории.

* Директория, где лежит код программы, загруженной из репозитория. В примере это "/home/user/veronica/scr".
Путь на директорию должен быть установлен при запуске программы в переменную окружения PYTHONPATH. 

* Файл проекта с описанием проекта, в том числе директорий с изображениями, по умолчанию "v0.prj", описан ниже.

* Директория "профайла" - директория, используемая программой для хранения существенных для неё даных. На Linux по умолчанию это директория "~/.veronica" ("/home/user/.veronica"), на Windows - "C:/veronica/profile". Запуск программы, если этой директории нет, постарается её создать. Для переопределения этой директории профайла есть ключ запуска программы: "-p <директория>" или то же: "--profile <директория>". 

#### 4. Запуск программы

Запуск программы по умолчанию выполняется из директории, где лежит файл "v0.prj":

> PYTHONPATH="/home/user/veronica/src/" python3 -m app.veronica

Варианты запуска:

* добавить переопределение профайла: "-p <директория>" или то же: "--profile <директория>"

* добавить в конец строки вызова путь на файл "v0.prj", _или_ на файл с любым именем с описанием проекта, если путь на этот файл будет полным, запуск программы можно выполнять из любой директории

* добавить в самый конец строки запуска что-нибудь типа "&> /home/user/veronica/log.err", для отслеживания ошибок в работе программы (особенно важно на Windows, где труднее увидеть и зафиксировать эти ошибки)

## Описание программы для пользователей

### Расположение изображений и файл проекта 

Изображения, с которыми работает программа, могут располагаться в нескольких директориях, при чём как в них самих, так и в их поддиректориях. Предположительно, именно в таком виде формируются директории с изображениями, полученными на электронном микроскопе. Изображения должны соответствовать формату TIF.

В примере используется одна такая директория "верхнего уровня":
```
Верхний уровень: 
/home/trifon/work/veronica/data/2024-07-16_17_extracellular_vesicles_cryoEM/

    Внутренний уровень:
    2024-07-16_control
    2024-07-17_stomach_cancer
```
_Внимание_: важная часть пути на изображение - имя директории, в которой непосредственно лежит изображение. В случае примера это имена "2024-07-16_control" и "2024-07-17_stomach_cancer", а имена более высокого уровна игнорируются. Запрещено запускать программу на директории, в которых есть конфликт/дублирование основных имён! (Позже конфликт будет опознаваться, но программа всё равно адекватно работать с такой путанной конфигурацией не будет!) (Настройка программы в отношении директорий с картинками выполнена с учётом логики регистрации серий изображений, снятых на микроскопе. Если такая настройка кому-то чем-то неудобна - скажите об этом разработчику.)


Рекомендуется сформировать файл проекта "v0.prj" со следующим содержимым:
```
{
    "mongo-host": "localhost",
    "mongo-port": 27017,
    "mongo-top": "Veronica",
    "prj-mode": "Vesiculae.0",
    "prj-name": "V0",
    "dir-list": [
        "/home/user/work/veronica/data/2024-07-16_17_extracellular_vesicles_cryoEM/"
    ]
}
```
Здесь: 

* mongo-... параметры задаются в контексте проекта (определяются администратором проекта), 

* prj-mode - (пока) зафиксированное значение, определяющее контекст проекта: "Vesiculae.0"

* prj-name - просто имя

* dir-list - список обрабатываемых директорий (в которых в свою очередь лежат директории с изображениями)

Запускать программу нужно или из директории, где лежит файл "v0.prj", или лежит только один файл с расширением ".prj", или с явным указанием полного пути на файл проекта. 

> PYTHONPATH="/home/trifon/work/veronica/src/" python3 -m app.veronica

### Общее описание интерфейса

Экран приложения разбит на левую и правую контольную полосу, разделитель между ними можно двигать мышью. 

Основную часть правой полосы занимает область изображения. Если изображение присутствует, его масштаб можно менять. Делается это не только в явном виде (справа сверху есть соответствующая управляющая область), и мышью: нажмите (на клавиатуре) контрольную клавишу CTRL и, находясь мышью внутри изображения, покрутите колесо на мыши. Также (только через управляющую область) можно менять контрастность изображения. 

Левая контрольная полоса в свою очередь разбита на верхнюю и нижние части. Разделитель можо двигать мышья.

Верхняя часть контрольной полосы обеспечивает навигацию по изображениям. Она содержит выбор режима навигации (Все изображения/Разметка), и окно со списком директорий и изображений. 

Список директорий и изображений представлен деревом, в котором можно раскрывать/закрывать поддиректории. Перемещение по списку меняет текущее изображение. Левая (узкая) колонка в окне списка обычно пуста, но изображения можно пометить (см. ниже), и эти метки появятся в изображении списка. 

В нижней часть контрольной полосы размещена информация и управляющие области, относяшиеся к текущему изображению

- контрольная полоса с управляющими кнопками (сохранить / сбросить / откатить / накатить)
- область "с табами": режимы работы с изображением:
    - Снимок - блок общей информации об изображении (описан ниже)
    - Разметка - блок с разметкой 
    - Зырк - экспериментальный блок (в нормальном режиме запуска должен быть недоступен)
    
Список изображений имеет различныйй вир в разных режимах навигации: 

 - В режиме "Все изображения" все изображения, присутствующие в директории, показываются сразу, и упорядочены по именам файлов с изображениями. В этом режиме изображения можно рассматривать, а также корректировать общую информацию об изображении, в блоке Снимок.
 
 - В режиме "Разметка" в списке показывается "немного" изображений, при этом в "случайном порядке" (описано ниже): в списке представлены как изображения, у которых уже есть разметка, а также несколько кандидатов на разметку. 
 

### Организация разметки изображений


### Элементы раметки изображений

В контексте разметки изображений с везикулами предоставляется возможность размечать следующие графические элементы:

- **везикула**: замкнутая сплайн-кривая, отрисовывается синим

- **сегмент везикулы**: незамкнутая сплайн-кривая, отрисовывается фиолетовым

- **линия помех**: незамкнутая сплайн-кривая, отрисовывается светло-голубым

- **клякса**: замкнутая сплайн-кривая, ограниченная область отрисовывается светло-голубой штриховкой

- **грязь**: замкнутая ломаная, ограниченная область отрисовывается синей штриховкой

В контексте проекта по везикулам рекомендуется:
 - размечать только типы **везикула** и **сегмент везикулы**
 - не размечать везикулы, если они вылезают за рамки изображения, при этом имея регулярную форму
 
Для добавления нового элемента в разметку нужно нажать кнопку с изображением зелёного плюса, и выбрать требуемый тип элемента (везикула / сегмент везикулы / и т.д). Далее указать по одной несколько точек - число определяется типом элемента. Указание выполняется левой клавишей на мыши.

_Внимание:_ после определения нового элемента система _остаётся в режиме определения новых элементов разметки_: можно определить подряд несколько элементов. Чтобы выйти из режима, отожмите кнопку с изображением зелёного плюса.

В нормальном режиме работы (с отжатой кнопкой с зелёным крестом) указание точки на изображении левой клавишей мыши вблизи элементов разметки (для площадей - вблизи границы) приводит к выделению элемента, и проявлению контрольных точек, определяющих элемент. Контрольные точки можно передвигать левой клавишей мыши. 

Добавление новых точек/сегментов в элемент выполняется кликом левой клавишей мыши при нажатой на клавиатуре клавише Shift. При этой нажатой клавише курсор мыши меняет свою форму над позициями, в которых операция добавления допустима.

Удаление лишних точек/сегментов из элемента выполняется кликом левой клавиши мыши при нажатой на клавиатуре клавише Ctrl. При этой нажатой клавише курсор мыши меняет свою форму над позициями, в которых операция удаления допустима - если количество точек/сегментов в элементе больше минимального.

Сплайн-кривые формируются из т.н. сегментов Безье, или кубических сплайнов Безье. Каждый сегмент определяется четырьмя точками: две крайние точки являются концами сегментов. Две управляющие промежуточные точки располагаются на плоскости произвольно, на задаваемой кривой как правило не лежат, но определяют касательные направления в концах сегмента. 

Для элементов типа "замкнутая сплайн-кривая" (везикула / клякса) минимальная конфигурация состоит из двух сегментов - 6 управляющих точек. При начальном определении такого элемента определяются две точки: строится сплайн-кривая, близкая к окружности, и опирающаяся на эти точки, как на (почти) диаметр. При дальнейшем редактировании элемент можно усложнить до кривой очень сложного вида: и движением контрольных точек, и вставкой дополнительных сегментов (с клавишей Shift). При задании сложной фогуры рекомендуется (но не обязательно) начинать разметку с указания двух самых дальних друг от друга "противоположных" точек. 

При заданиии/редактировании элементов разметки работает откатка, а (также реверс откатки) - см. кнопки с соответствующими стрелочками (зелёной и жёлтой). Задание/редактирование разметки необходимо закончить нажатем на кнопку сохранения - иначе модификации потеряются.

При первоначальном ознакомлении с программой рекомендуется попрактиковаться в задании/редактировании элементов разметки,  соотнести его с этим описанием и уяснить, как вся эта функциональность работает. Это уменьшит трудности при выполнении дальнейшей разметки.  
